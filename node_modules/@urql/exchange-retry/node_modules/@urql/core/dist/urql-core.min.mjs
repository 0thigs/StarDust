import{visit as e,Kind as r}from"graphql";import{k as t,s as n,C as o,m as s,a as u,b as c,c as l,d as y,e as p,g as d,f as k}from"./3ec93f64.min.mjs";export{C as CombinedError,f as createRequest,j as getOperationName,a as makeErrorResult,m as makeResult,i as mergeResultPatch,h as stringifyVariables}from"./3ec93f64.min.mjs";import{subscribe as v,share as x,map as w,filter as q,tap as b,merge as g,mergeMap as O,takeUntil as _,make as P,onPush as E,fromPromise as S,fromValue as N,makeSubject as R,onEnd as M,onStart as D,publish as A,take as Q,switchMap as F}from"wonka";var I=(e,r)=>{if(Array.isArray(e))for(var t of e)I(t,r);else if("object"==typeof e&&null!==e)for(var n in e)"__typename"===n&&"string"==typeof e[n]?r.add(e[n]):I(e[n],r);return r},L=e=>{if(!e.selectionSet)return e;for(var t of e.selectionSet.selections)if(t.kind===r.FIELD&&"__typename"===t.name.value&&!t.alias)return e;return{...e,selectionSet:{...e.selectionSet,selections:[...e.selectionSet.selections,{kind:r.FIELD,name:{kind:r.NAME,value:"__typename"}}]}}},T=new Map,J=r=>{var n=t(r),a=T.get(n.__key);return a||(a=e(n,{Field:L,InlineFragment:L}),Object.defineProperty(a,"__key",{value:n.__key,enumerable:!1}),T.set(n.__key,a)),a},G=(e,r)=>{if(e&&"object"==typeof e){if(Array.isArray(e))return e.map((e=>G(e)));if(e&&"object"==typeof e&&(r||"__typename"in e)){var t={};for(var n in e)"__typename"===n?Object.defineProperty(t,"__typename",{enumerable:!1,value:e.__typename}):t[n]=G(e[n]);return t}return e}return e};function U(e){return e.toPromise=()=>new Promise((r=>{var t=v((e=>{e.stale||e.hasNext||Promise.resolve().then((()=>{t.unsubscribe(),r(e)}))}))(e)})),e}function V(e,r,t){return t||(t=r.context),{key:r.key,query:r.query,variables:r.variables,kind:e,context:t}}var W=(e,r)=>V(e.kind,e,{...e.context,meta:{...e.context.meta,...r}}),$=()=>{},z=(e,t,a)=>{for(var o of a)if(o.kind===r.FRAGMENT_DEFINITION){var i=o.name.value,s=n(o);e.has(i)||(e.set(i,s),t.push(o))}else t.push(o)};function B(){for(var e=new Map,n=[],a=[],o=Array.isArray(arguments[0])?arguments[0][0]:arguments[0]||"",i=1;i<arguments.length;i++){var s=arguments[i];s&&s.definitions?a.push(...s.definitions):o+=s,o+=arguments[0][i]}return z(e,n,t(o).definitions),z(e,n,a),t({kind:r.DOCUMENT,definitions:n})}var H=({kind:e})=>"mutation"!==e&&"query"!==e,K=({forward:e,client:r})=>{var t=new Map,n=new Map,a=e=>{var r=V(e.kind,e);return r.query=J(e.query),r},o=e=>{var{key:r,kind:n,context:{requestPolicy:a}}=e;return"query"===n&&"network-only"!==a&&("cache-only"===a||t.has(r))};return i=>{var s=x(i),u=w((e=>{var n=t.get(e.key),a={...n,operation:W(e,{cacheOutcome:n?"hit":"miss"})};return"cache-and-network"===e.context.requestPolicy&&(a.stale=!0,X(r,e)),a}))(q((e=>!H(e)&&o(e)))(s)),c=b((e=>{var{operation:a}=e;if(a){var o=(e=>[...I(e,new Set)])(e.data).concat(a.context.additionalTypenames||[]);if("mutation"===e.operation.kind){for(var i=new Set,s=0;s<o.length;s++){var u=o[s],c=n.get(u);for(var l of(c||n.set(u,c=new Set),c.values()))i.add(l);c.clear()}for(var y of i.values())t.has(y)&&(a=t.get(y).operation,t.delete(y),X(r,a))}else if("query"===a.kind&&e.data){t.set(a.key,e);for(var p=0;p<o.length;p++){var d=o[p],k=n.get(d);k||n.set(d,k=new Set),k.add(a.key)}}}}))(e(q((e=>"query"!==e.kind||"cache-only"!==e.context.requestPolicy))(w((e=>W(e,{cacheOutcome:"miss"})))(g([w(a)(q((e=>!H(e)&&!o(e)))(s)),q((e=>H(e)))(s)])))));return g([u,c])}},X=(e,r)=>e.reexecuteOperation(V(r.kind,r,{...r.context,requestPolicy:"network-only"})),Y=new Set,Z=(e={})=>{var r=!!e.staleWhileRevalidate,t=!!e.includeExtensions,n={},a=[],i=e=>{a.push(e.operation.key),1===a.length&&Promise.resolve().then((()=>{for(var e;e=a.shift();)n[e]=null}))},s=({client:a,forward:s})=>u=>{var c=e&&"boolean"==typeof e.isClient?!!e.isClient:!a.suspense,l=x(u),y=s(q((e=>!n[e.key]||!!n[e.key].hasNext||"network-only"===e.context.requestPolicy))(l)),p=w((e=>{var i=((e,r,t)=>({operation:e,data:r.data?JSON.parse(r.data):void 0,extensions:t&&r.extensions?JSON.parse(r.extensions):void 0,error:r.error?new o({networkError:r.error.networkError?new Error(r.error.networkError):void 0,graphQLErrors:r.error.graphQLErrors}):void 0,hasNext:r.hasNext}))(e,n[e.key],t);return r&&!Y.has(e.key)&&(i.stale=!0,Y.add(e.key),X(a,e)),{...i,operation:W(e,{cacheOutcome:"hit"})}}))(q((e=>!!n[e.key]&&"network-only"!==e.context.requestPolicy))(l));return c?p=b(i)(p):y=b((e=>{var{operation:r}=e;if("mutation"!==r.kind){var a=(({hasNext:e,data:r,extensions:t,error:n},a)=>{var o={};return void 0!==r&&(o.data=JSON.stringify(r)),a&&void 0!==t&&(o.extensions=JSON.stringify(t)),e&&(o.hasNext=!0),n&&(o.error={graphQLErrors:n.graphQLErrors.map((e=>e.path||e.extensions?{message:e.message,path:e.path,extensions:e.extensions}:e.message))},n.networkError&&(o.error.networkError=""+n.networkError)),o})(e,t);n[r.key]=a}}))(y),g([y,p])};return s.restoreData=e=>{for(var r in e)null!==n[r]&&(n[r]=e[r])},s.extractData=()=>{var e={};for(var r in n)null!=n[r]&&(e[r]=n[r]);return e},e&&e.initialState&&s.restoreData(e.initialState),s},ee=({forwardSubscription:e,enableAllOperations:r,isSubscriptionOperation:t})=>({client:a,forward:o})=>{var i=t||(e=>{var{kind:t}=e;return"subscription"===t||!!r&&("query"===t||"mutation"===t)});return r=>{var t=x(r),c=O((r=>{var{key:o}=r,i=q((e=>"teardown"===e.kind&&e.key===o))(t);return _(i)((r=>{var t=e({key:r.key.toString(36),query:n(r.query),variables:r.variables,context:{...r.context}});return P((({next:e,complete:n})=>{var o,i=!1;return Promise.resolve().then((()=>{i||(o=t.subscribe({next:t=>e(s(r,t)),error:t=>e(u(r,t)),complete:()=>{i||(i=!0,"subscription"===r.kind&&a.reexecuteOperation(V("teardown",r,r.context)),n())}}))})),()=>{i=!0,o&&o.unsubscribe()}}))})(r))}))(q(i)(t)),l=o(q((e=>!i(e)))(t));return g([c,l])}},re=({forward:e})=>r=>e(r),te=({forward:e})=>{var r=new Set,t=e=>{var{key:t,kind:n}=e;if("teardown"===n||"mutation"===n)return r.delete(t),!0;var a=r.has(t);return r.add(t),!a},n=({operation:e,hasNext:t})=>{t||r.delete(e.key)};return r=>{var a=q(t)(r);return b(n)(e(a))}},ne=({forward:e})=>r=>{var t=x(r),n=O((e=>{var{key:r}=e,n=c(e),a=l(e,n),o=y(e,n);return _(q((e=>"teardown"===e.kind&&e.key===r))(t))(p(e,a,o))}))(q((e=>"query"===e.kind||"mutation"===e.kind))(t)),a=e(q((e=>"query"!==e.kind&&"mutation"!==e.kind))(t));return g([n,a])},ae=({})=>e=>q((()=>!1))(b((e=>{}))(e)),oe=ae({dispatchDebug:$}),ie=e=>({client:r,forward:t})=>e.reduceRight(((e,t)=>t({client:r,forward:e,dispatchDebug(e){}})),t),se=({onOperation:e,onResult:r,onError:t})=>({forward:n})=>a=>O((e=>{t&&e.error&&t(e.error,e.operation);var n=r&&r(e)||e;return"then"in n?S(n):N(n)}))(n(O((r=>{var t=e&&e(r)||r;return"then"in t?S(t):N(t)}))(a))),ue=[te,K,ne],ce=function e(r){var t=0,n=new Map,a=new Map,o=[],i={url:r.url,fetchOptions:r.fetchOptions,fetch:r.fetch,preferGetMethod:!!r.preferGetMethod,requestPolicy:r.requestPolicy||"cache-first"},{source:s,next:u}=R(),c=!1;function l(e){if(e&&u(e),!c){for(c=!0;c&&(e=o.shift());)u(e);c=!1}}var y=e=>{var t=q((r=>r.operation.kind===e.kind&&r.operation.key===e.key&&(!r.operation.context._instance||r.operation.context._instance===e.context._instance)))(b);return r.maskTypename&&(t=w((e=>({...e,data:G(e.data,!0)})))(t)),"mutation"===e.kind?Q(1)(D((()=>u(e)))(t)):x(M((()=>{n.delete(e.key),a.delete(e.key);for(var r=o.length-1;r>=0;r--)o[r].key===e.key&&o.splice(r,1);u(V("teardown",e,e.context))}))(E((r=>{n.set(e.key,r)}))(F((r=>"query"!==e.kind||r.stale?N(r):g([N(r),w((()=>({...r,stale:!0})))(Q(1)(q((r=>"query"===r.kind&&r.key===e.key&&"cache-only"!==r.context.requestPolicy))(s)))])))(_(q((r=>"teardown"===r.kind&&r.key===e.key))(s))(t)))))},p=this instanceof e?this:Object.create(e.prototype),f=Object.assign(p,{suspense:!!r.suspense,operations$:s,reexecuteOperation(e){("mutation"===e.kind||a.has(e.key))&&(o.push(e),Promise.resolve().then(l))},createRequestOperation:(e,r,n)=>(n||(n={}),d(r.query),V(e,r,{_instance:"mutation"===e?t=t+1|0:void 0,...i,...n,requestPolicy:n.requestPolicy||i.requestPolicy,suspense:n.suspense||!1!==n.suspense&&f.suspense})),executeRequestOperation:e=>"mutation"===e.kind?y(e):P((r=>{var t=a.get(e.key);t||a.set(e.key,t=y(e));var o="cache-and-network"===e.context.requestPolicy||"network-only"===e.context.requestPolicy;return v(r.next)(M((()=>{c=!1,r.complete()}))(D((()=>{var t=n.get(e.key);if("subscription"===e.kind)return l(e);o&&l(e),null!=t&&t===n.get(e.key)?r.next(o?{...t,stale:!0}:t):o||l(e)}))(t))).unsubscribe})),executeQuery(e,r){var t=f.createRequestOperation("query",e,r);return f.executeRequestOperation(t)},executeSubscription(e,r){var t=f.createRequestOperation("subscription",e,r);return f.executeRequestOperation(t)},executeMutation(e,r){var t=f.createRequestOperation("mutation",e,r);return f.executeRequestOperation(t)},query:(e,r,t)=>(t&&"boolean"==typeof t.suspense||(t={...t,suspense:!1}),U(f.executeQuery(k(e,r),t))),readQuery(e,r,t){var n=null;return v((e=>{n=e}))(f.query(e,r,t)).unsubscribe(),n},subscription:(e,r,t)=>f.executeSubscription(k(e,r),t),mutation:(e,r,t)=>U(f.executeMutation(k(e,r),t))}),h=$,m=ie(void 0!==r.exchanges?r.exchanges:ue),b=x(m({client:f,dispatchDebug:h,forward:ae({dispatchDebug:h})})(s));return A(b),f},le=ce;export{ce as Client,K as cacheExchange,ie as composeExchanges,le as createClient,re as debugExchange,te as dedupExchange,ue as defaultExchanges,se as errorExchange,oe as fallbackExchangeIO,ne as fetchExchange,J as formatDocument,B as gql,V as makeOperation,se as mapExchange,G as maskTypename,Z as ssrExchange,ee as subscriptionExchange};
//# sourceMappingURL=urql-core.min.mjs.map
