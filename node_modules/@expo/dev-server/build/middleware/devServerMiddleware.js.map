{"version":3,"file":"devServerMiddleware.js","names":["createDevServerMiddleware","projectRoot","watchFolders","port","logger","securityHeadersMiddleware","importCliServerApiFromProject","middleware","attachToServer","debuggerProxyEndpoint","messageSocketEndpoint","eventsSocketEndpoint","websocketEndpoints","replaceMiddlewareWith","remoteDevtoolsSecurityHeadersMiddleware","use","remoteDevtoolsCorsMiddleware","prependMiddleware","suppressRemoteDebuggingErrorMiddleware","bodyParser","json","clientLogsMiddleware","createJsInspectorMiddleware"],"sources":["../../src/middleware/devServerMiddleware.ts"],"sourcesContent":["import Log from '@expo/bunyan';\nimport bodyParser from 'body-parser';\nimport { Server as ConnectServer } from 'connect';\n\nimport { importCliServerApiFromProject } from '../metro/importMetroFromProject';\nimport { prependMiddleware, replaceMiddlewareWith } from '../middlwareMutations';\nimport clientLogsMiddleware from './clientLogsMiddleware';\nimport createJsInspectorMiddleware from './createJsInspectorMiddleware';\nimport { remoteDevtoolsCorsMiddleware } from './remoteDevtoolsCorsMiddleware';\nimport { remoteDevtoolsSecurityHeadersMiddleware } from './remoteDevtoolsSecurityHeadersMiddleware';\nimport { suppressRemoteDebuggingErrorMiddleware } from './suppressErrorMiddleware';\n\n/**\n * Extends the default `createDevServerMiddleware` and adds some Expo CLI-specific dev middleware\n * with exception for the manifest middleware which is currently in `xdl`.\n *\n * Adds:\n * - `/logs`: pipe runtime `console` logs to the `props.logger` object.\n * - `/inspector`: launch hermes inspector proxy in chrome.\n * - CORS support for remote devtools\n * - body parser middleware\n *\n * @param props.watchFolders array of directory paths to use with watchman\n * @param props.port port that the dev server will run on\n * @param props.logger bunyan instance that all runtime `console` logs will be piped through.\n *\n * @returns\n */\nexport function createDevServerMiddleware(\n  projectRoot: string,\n  {\n    watchFolders,\n    port,\n    logger,\n  }: {\n    watchFolders: readonly string[];\n    port: number;\n    logger: Log;\n  }\n) {\n  const { createDevServerMiddleware, securityHeadersMiddleware } =\n    importCliServerApiFromProject(projectRoot);\n  const {\n    middleware,\n    // @ts-expect-error: Old API\n    attachToServer,\n\n    // New\n    debuggerProxyEndpoint,\n    messageSocketEndpoint,\n    eventsSocketEndpoint,\n    websocketEndpoints,\n  } = createDevServerMiddleware({\n    port,\n    watchFolders,\n  });\n\n  // securityHeadersMiddleware does not support cross-origin requests for remote devtools to get the sourcemap.\n  // We replace with the enhanced version.\n  replaceMiddlewareWith(\n    middleware as ConnectServer,\n    securityHeadersMiddleware,\n    remoteDevtoolsSecurityHeadersMiddleware\n  );\n  middleware.use(remoteDevtoolsCorsMiddleware);\n  prependMiddleware(middleware, suppressRemoteDebuggingErrorMiddleware);\n\n  middleware.use(bodyParser.json());\n  middleware.use('/logs', clientLogsMiddleware(logger));\n  middleware.use('/inspector', createJsInspectorMiddleware());\n\n  return {\n    logger,\n    middleware,\n    // Old\n    attachToServer,\n    // New\n    debuggerProxyEndpoint,\n    messageSocketEndpoint,\n    eventsSocketEndpoint,\n    websocketEndpoints,\n  };\n}\n"],"mappings":";;;;;;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAGA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASA,yBAAT,CACLC,WADK,EAEL;EACEC,YADF;EAEEC,IAFF;EAGEC;AAHF,CAFK,EAWL;EACA,MAAM;IAAEJ,yBAAF;IAA6BK;EAA7B,IACJ,IAAAC,uDAAA,EAA8BL,WAA9B,CADF;EAEA,MAAM;IACJM,UADI;IAEJ;IACAC,cAHI;IAKJ;IACAC,qBANI;IAOJC,qBAPI;IAQJC,oBARI;IASJC;EATI,IAUFZ,yBAAyB,CAAC;IAC5BG,IAD4B;IAE5BD;EAF4B,CAAD,CAV7B,CAHA,CAkBA;EACA;;EACA,IAAAW,2CAAA,EACEN,UADF,EAEEF,yBAFF,EAGES,kFAHF;EAKAP,UAAU,CAACQ,GAAX,CAAeC,4DAAf;EACA,IAAAC,uCAAA,EAAkBV,UAAlB,EAA8BW,iEAA9B;EAEAX,UAAU,CAACQ,GAAX,CAAeI,qBAAA,CAAWC,IAAX,EAAf;EACAb,UAAU,CAACQ,GAAX,CAAe,OAAf,EAAwB,IAAAM,+BAAA,EAAqBjB,MAArB,CAAxB;EACAG,UAAU,CAACQ,GAAX,CAAe,YAAf,EAA6B,IAAAO,sCAAA,GAA7B;EAEA,OAAO;IACLlB,MADK;IAELG,UAFK;IAGL;IACAC,cAJK;IAKL;IACAC,qBANK;IAOLC,qBAPK;IAQLC,oBARK;IASLC;EATK,CAAP;AAWD"}