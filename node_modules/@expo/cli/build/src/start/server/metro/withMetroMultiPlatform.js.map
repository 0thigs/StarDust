{"version":3,"sources":["../../../../../src/start/server/metro/withMetroMultiPlatform.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport fs from 'fs';\nimport { ConfigT } from 'metro-config';\nimport { ResolutionContext } from 'metro-resolver';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\n\nimport { env } from '../../../utils/env';\nimport { WebSupportProjectPrerequisite } from '../../doctor/web/WebSupportProjectPrerequisite';\nimport { PlatformBundlers } from '../platformBundlers';\nimport { importMetroResolverFromProject } from './resolveFromProject';\nimport { getAppRouterRelativeEntryPath } from './router';\n\nfunction withWebPolyfills(config: ConfigT): ConfigT {\n  const originalGetPolyfills = config.serializer.getPolyfills\n    ? config.serializer.getPolyfills.bind(config.serializer)\n    : () => [];\n\n  const getPolyfills = (ctx: { platform: string | null | undefined }): readonly string[] => {\n    if (ctx.platform === 'web') {\n      return [\n        // TODO: runtime polyfills, i.e. Fast Refresh, error overlay, React Dev Tools...\n      ];\n    }\n    // Generally uses `rn-get-polyfills`\n    return originalGetPolyfills(ctx);\n  };\n\n  return {\n    ...config,\n    serializer: {\n      ...config.serializer,\n      getPolyfills,\n    },\n  };\n}\n\nfunction getDefaultResolveRequest(projectRoot: string) {\n  const { resolve } = importMetroResolverFromProject(projectRoot);\n  return (context: ResolutionContext, moduleName: string, platform: string | null) => {\n    return resolve(context, moduleName, platform);\n  };\n}\n\nexport type ExpoCustomMetroResolver = (\n  ...args: Parameters<import('metro-resolver').CustomResolver>\n) => import('metro-resolver').Resolution | null;\n\n/** Extend the `resolver.resolveRequest` method with custom methods that can exit early by returning a `Resolution`. */\nfunction withCustomResolvers(\n  config: ConfigT,\n  projectRoot: string,\n  resolvers: ExpoCustomMetroResolver[]\n): ConfigT {\n  const originalResolveRequest =\n    config.resolver.resolveRequest || getDefaultResolveRequest(projectRoot);\n\n  return {\n    ...config,\n    resolver: {\n      ...config.resolver,\n      resolveRequest(...args: Parameters<import('metro-resolver').CustomResolver>) {\n        for (const resolver of resolvers) {\n          const resolution = resolver(...args);\n          if (resolution) {\n            return resolution;\n          }\n        }\n        return originalResolveRequest(...args);\n      },\n    },\n  };\n}\n\n/**\n * Apply custom resolvers to do the following:\n * - Disable `.native.js` extensions on web.\n * - Alias `react-native` to `react-native-web` on web.\n * - Redirect `react-native-web/dist/modules/AssetRegistry/index.js` to `@react-native/assets/registry.js` on web.\n */\nexport function withWebResolvers(config: ConfigT, projectRoot: string) {\n  // Get the `transformer.assetRegistryPath`\n  // this needs to be unified since you can't dynamically\n  // swap out the transformer based on platform.\n  const assetRegistryPath = fs.realpathSync(\n    // This is the native asset registry alias for native.\n    path.resolve(resolveFrom(projectRoot, 'react-native/Libraries/Image/AssetRegistry'))\n    // NOTE(EvanBacon): This is the newer import but it doesn't work in the expo/expo monorepo.\n    // path.resolve(resolveFrom(projectRoot, '@react-native/assets/registry.js'))\n  );\n\n  // Create a resolver which dynamically disables support for\n  // `*.native.*` extensions on web.\n\n  const { resolve } = importMetroResolverFromProject(projectRoot);\n\n  const extraNodeModules: { [key: string]: Record<string, string> } = {\n    web: {\n      'react-native': path.resolve(require.resolve('react-native-web/package.json'), '..'),\n    },\n  };\n\n  const preferredMainFields: { [key: string]: string[] } = {\n    // Defaults from Expo Webpack. Most packages using `react-native` don't support web\n    // in the `react-native` field, so we should prefer the `browser` field.\n    // https://github.com/expo/router/issues/37\n    web: ['browser', 'module', 'main'],\n  };\n\n  return withCustomResolvers(config, projectRoot, [\n    // Add a resolver to alias the web asset resolver.\n    (immutableContext: ResolutionContext, moduleName: string, platform: string | null) => {\n      const context = { ...immutableContext } as ResolutionContext & { mainFields: string[] };\n\n      // Conditionally remap `react-native` to `react-native-web`\n      if (platform && platform in extraNodeModules) {\n        context.extraNodeModules = extraNodeModules[platform];\n      }\n\n      const mainFields = env.EXPO_METRO_NO_MAIN_FIELD_OVERRIDE\n        ? context.mainFields\n        : platform && platform in preferredMainFields\n        ? preferredMainFields[platform]\n        : context.mainFields;\n\n      const result = resolve(\n        {\n          ...context,\n          preferNativePlatform: platform !== 'web',\n          resolveRequest: undefined,\n\n          // Passing `mainFields` directly won't be considered\n          // we need to extend the `getPackageMainPath` directly to\n          // use platform specific `mainFields`.\n          getPackageMainPath(packageJsonPath) {\n            // @ts-expect-error: mainFields is not on type\n            const package_ = context.moduleCache.getPackage(packageJsonPath);\n            return package_.getMain(mainFields);\n          },\n        },\n        moduleName,\n        platform\n      );\n\n      // Replace the web resolver with the original one.\n      // This is basically an alias for web-only.\n      if (\n        platform === 'web' &&\n        result?.type === 'sourceFile' &&\n        typeof result?.filePath === 'string' &&\n        result.filePath.endsWith('react-native-web/dist/modules/AssetRegistry/index.js')\n      ) {\n        // @ts-expect-error: `readonly` for some reason.\n        result.filePath = assetRegistryPath;\n      }\n\n      return result;\n    },\n  ]);\n}\n\n/** Add support for `react-native-web` and the Web platform. */\nexport async function withMetroMultiPlatformAsync(\n  projectRoot: string,\n  config: ConfigT,\n  platformBundlers: PlatformBundlers\n) {\n  // Auto pick App entry: this is injected with Babel.\n  process.env.EXPO_ROUTER_APP_ROOT = getAppRouterRelativeEntryPath(projectRoot);\n  process.env.EXPO_PROJECT_ROOT = process.env.EXPO_PROJECT_ROOT ?? projectRoot;\n\n  if (platformBundlers.web === 'metro') {\n    await new WebSupportProjectPrerequisite(projectRoot).assertAsync();\n  } else {\n    // Bail out early for performance enhancements if web is not enabled.\n    return config;\n  }\n\n  return withMetroMultiPlatform(projectRoot, config, platformBundlers);\n}\n\nfunction withMetroMultiPlatform(\n  projectRoot: string,\n  config: ConfigT,\n  platformBundlers: PlatformBundlers\n) {\n  let expoConfigPlatforms = Object.entries(platformBundlers)\n    .filter(([, bundler]) => bundler === 'metro')\n    .map(([platform]) => platform);\n\n  if (Array.isArray(config.resolver.platforms)) {\n    expoConfigPlatforms = [...new Set(expoConfigPlatforms.concat(config.resolver.platforms))];\n  }\n\n  // @ts-expect-error: typed as `readonly`.\n  config.resolver.platforms = expoConfigPlatforms;\n\n  config = withWebPolyfills(config);\n\n  return withWebResolvers(config, projectRoot);\n}\n"],"names":["withWebResolvers","withMetroMultiPlatformAsync","withWebPolyfills","config","originalGetPolyfills","serializer","getPolyfills","bind","ctx","platform","getDefaultResolveRequest","projectRoot","resolve","importMetroResolverFromProject","context","moduleName","withCustomResolvers","resolvers","originalResolveRequest","resolver","resolveRequest","args","resolution","assetRegistryPath","fs","realpathSync","path","resolveFrom","extraNodeModules","web","require","preferredMainFields","immutableContext","mainFields","env","EXPO_METRO_NO_MAIN_FIELD_OVERRIDE","result","preferNativePlatform","undefined","getPackageMainPath","packageJsonPath","package_","moduleCache","getPackage","getMain","type","filePath","endsWith","platformBundlers","process","EXPO_ROUTER_APP_ROOT","getAppRouterRelativeEntryPath","EXPO_PROJECT_ROOT","WebSupportProjectPrerequisite","assertAsync","withMetroMultiPlatform","expoConfigPlatforms","Object","entries","filter","bundler","map","Array","isArray","platforms","Set","concat"],"mappings":"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"}